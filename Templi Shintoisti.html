<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Templi Shintoisti | Shinto Italia</title>

  <!-- Leaflet CSS (HTTPS + SRI) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    :root { --accent:#d33; --bg:#fff; --text:#111; }
    html,body{margin:0;height:100%}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
    header{padding:.75rem 1rem;border-bottom:1px solid #eee}
    header h1{font-size:1.1rem;margin:.2rem 0}
    #container{display:flex;flex-direction:column;height:calc(100% - 56px)}
    #map{flex:1 1 auto;min-height:60vh}
    #list{max-height:32vh;overflow:auto;border-top:1px solid #eee}
    #list ul{list-style:none;margin:0;padding:.5rem}
    #list li{padding:.4rem .2rem;border-bottom:1px dashed #eee;cursor:pointer}
    #list li:hover{background:#fafafa}
    .popup h3{margin:.2rem 0 .4rem;font-size:1.05rem}
    .popup img{display:block;max-width:220px;max-height:150px;width:auto;height:auto;border-radius:6px;margin:.25rem 0}
    .popup a{color:var(--accent);text-decoration:none}
    .popup a:hover{text-decoration:underline}
    .note{font-size:.85rem;color:#555}
  </style>
</head>
<body>
  <header>
    <h1>Templi Shintoisti</h1>
    <div class="note">Tocca un elemento in lista o un marker sulla mappa. I link aprono <em>nella stessa pagina</em> (niente finestre nuove).</div>
  </header>

  <div id="container">
    <div id="map" role="region" aria-label="Mappa templi shintoisti"></div>
    <nav id="list" aria-label="Elenco templi">
      <ul id="templeList"></ul>
    </nav>
  </div>

  <!-- Leaflet JS (HTTPS + SRI) -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    // ===========================
    // 1) Dati dei templi
    // ===========================
    const TEMPLES = [
      { name:"Fushimi Inari Taisha – Kyoto",       lat:34.9671, lng:135.7727, image:"" },
      { name:"Ise Jingū – Mie",                    lat:34.4467, lng:136.7206, image:"" },
      { name:"Izumo Taisha – Shimane",             lat:35.2074, lng:132.6853, image:"" },
      { name:"Meiji Jingū – Tokyo",                lat:35.6764, lng:139.6993, image:"" },
      { name:"Toshogu – Nikko",                    lat:36.7578, lng:139.5986, image:"" },
      { name:"Kashima Jingū – Ibaraki",            lat:35.9736, lng:140.6383, image:"" },
      { name:"Sumiyoshi Taisha – Osaka",           lat:34.6121, lng:135.4861, image:"" },
      { name:"Itsukushima Jinja – Hiroshima",      lat:34.2961, lng:132.3194, image:"" },
      { name:"Hirano Jinja – Kyoto",               lat:35.0306, lng:135.7278, image:"" },
      { name:"Umi-no-Nakamichi Shrine – Fukuoka",  lat:33.6516, lng:130.3894, image:"" },
      { name:"Hokkaido Jingu – Sapporo",           lat:43.0621, lng:141.3406, image:"" },
      { name:"Heian Jingu – Kyoto",                lat:35.0156, lng:135.7809, image:"" },
      { name:"Yasukuni Jinja – Tokyo",             lat:35.6940, lng:139.7432, image:"" },
      { name:"Omi Jingu – Otsu",                   lat:35.0025, lng:135.8783, image:"" },
      { name:"Udo Jingu – Miyazaki",               lat:31.8031, lng:131.4489, image:"" },
      { name:"Chichibu Jinja – Saitama",           lat:35.9946, lng:139.0856, image:"" },
      { name:"Hakone Jinja – Kanagawa",            lat:35.2136, lng:139.0278, image:"" },
      { name:"Nezu Jinja – Tokyo",                 lat:35.7176, lng:139.7606, image:"" },
      { name:"Hikawa Jinja – Saitama",             lat:35.9064, lng:139.6256, image:"" },
      { name:"Oarai Isosaki Jinja – Ibaraki",      lat:36.3183, lng:140.5833, image:"" },
    ];

    // ===========================
    // 2) Inizializza mappa Leaflet
    // ===========================
    const map = L.map('map', { scrollWheelZoom: true });

    // Tile layer OSM Standard (HTTPS).
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; <a href="https://openstreetmap.org/">OpenStreetMap</a> contributors'
    }).addTo(map);

    const markers = [];
    const bounds = [];

    // ===========================
    // 3) Markers + popup
    // ===========================
    function popupContent(t) {
      const gmaps = `https://www.google.com/maps/search/?api=1&query=${t.lat},${t.lng}`;
      const img   = (t.image && t.image.startsWith('https://'))
        ? `<img src="${t.image}" alt="${t.name}" loading="lazy"
               onerror="this.style.display='none'">`
        : '';
      return `
        <div class="popup">
          <h3>${t.name}</h3>
          ${img}
          <p class="note">Lat: ${t.lat.toFixed(4)} &middot; Lng: ${t.lng.toFixed(4)}</p>
          <p><a href="${gmaps}">Apri su Google Maps</a></p>
        </div>
      `;
    }

    TEMPLES.forEach((t, i) => {
      const m = L.marker([t.lat, t.lng]).addTo(map).bindPopup(popupContent(t));
      markers.push(m);
      bounds.push([t.lat, t.lng]);
    });

    if (bounds.length) map.fitBounds(bounds, { padding: [24, 24] });

    // ===========================
    // 4) Lista cliccabile
    // ===========================
    const ul = document.getElementById('templeList');
    TEMPLES.forEach((t, i) => {
      const li = document.createElement('li');
      li.textContent = t.name;
      li.title = `Vai a ${t.name}`;
      li.addEventListener('click', () => {
        map.flyTo([t.lat, t.lng], 14, { duration: .6 });
        markers[i].openPopup();
      });
      ul.appendChild(li);
    });

    // ===========================
    // 5) Evita target="_blank" (per compatibilità con WebView)
    // ===========================
    window.addEventListener('load', () => {
      document.querySelectorAll('a[target="_blank"]').forEach(a => a.target = '_self');
    });
  </script>
</body>
</html>
